#!/usr/bin/env python3
from __future__ import annotations

import json
from http import HTTPStatus

from remote_admin_backend import ssh_client


def _respond(status: HTTPStatus, payload: dict) -> None:
    print(f"Status: {status.value} {status.phrase}")
    print("Content-Type: application/json")
    print()
    print(json.dumps(payload))


def main() -> None:
    try:
        stdout, stderr, exit_code = ssh_client.run_at_command("ATI", timeout=20)
    except ssh_client.RemoteConnectionError as exc:
        _respond(
            HTTPStatus.BAD_GATEWAY,
            {"success": False, "message": str(exc)},
        )
        return

    if exit_code != 0 or stderr.strip():
        message = stderr.strip() or f"ATI failed with exit code {exit_code}."
        _respond(
            HTTPStatus.BAD_GATEWAY,
            {"success": False, "message": message, "output": stdout.strip()},
        )
        return

    cleaned = stdout.strip() or "Modem responded."
    _respond(
        HTTPStatus.OK,
        {"success": True, "message": "Connection OK", "output": cleaned},
    )


if __name__ == "__main__":
    main()
