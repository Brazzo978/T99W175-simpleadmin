#!/usr/bin/env python3
"""Manage the remote SSH configuration for Simple Admin."""
from __future__ import annotations

import os
import sys
from pathlib import Path

def _find_project_root() -> Path:
    current = Path(__file__).resolve()
    for candidate in current.parents:
        if (candidate / "remote_admin_backend").is_dir():
            return candidate
    return current.parents[0]


ROOT = _find_project_root()
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

from remote_admin_backend.config import load_config, save_config  # type: ignore  # noqa: E402
from remote_admin_backend.http_utils import (  # type: ignore  # noqa: E402
    HTTPError,
    ensure_method,
    handle_error,
    read_json_body,
    send_json,
)


SENSITIVE_FIELDS = {"password"}


def sanitize_payload(payload: dict) -> dict:
    clean = {k: v for k, v in payload.items() if isinstance(v, (str, int))}
    return clean


def mask_password(config: dict) -> dict:
    safe = dict(config)
    if safe.get("password"):
        safe["password"] = "***"
    return safe


def main() -> None:
    environ = os.environ.copy()
    method = environ.get("REQUEST_METHOD", "GET").upper()

    ensure_method(environ, {"GET", "POST"})

    if method == "GET":
        config = load_config()
        send_json({"success": True, "config": mask_password(config)})
        return

    payload = sanitize_payload(read_json_body(environ))
    if not payload:
        raise HTTPError("Empty configuration payload.")

    current = load_config()

    updates = {}
    for key, value in payload.items():
        if key in SENSITIVE_FIELDS and isinstance(value, str) and value == "***":
            continue
        updates[key] = value

    if "ssh_port" in updates:
        try:
            updates["ssh_port"] = int(updates["ssh_port"])
        except (ValueError, TypeError):
            raise HTTPError("ssh_port must be a number.")

    current.update(updates)
    save_config(current)
    send_json({"success": True, "message": "Configuration saved."})


if __name__ == "__main__":
    try:
        main()
    except HTTPError as error:
        handle_error(error)
    except Exception as exc:  # pragma: no cover
        handle_error(HTTPError(f"Unexpected error: {exc}", status=500))
