#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
    send_json_response 401 '{"status":"error","message":"Authentication required"}'
    exit 0
fi

ttlvalue=$(
    /usr/sbin/iptables -w 5 -t mangle -S POSTROUTING 2>/dev/null \
      | sed -n 's/^-A POSTROUTING -o rmnet+ -j TTL --ttl-set \([0-9]\{1,3\}\)$/\1/p' \
      | head -n 1
)

if [ -z "${ttlvalue}" ]; then
    ttlvalue=0
    ttlenabled=false
else
    ttlenabled=true
fi

json_payload=$(cat <<EOF
{
  "status":"ok",
  "isEnabled":${ttlenabled},
  "ttl":${ttlvalue}
}
EOF
)

send_json_response 200 "$json_payload"
