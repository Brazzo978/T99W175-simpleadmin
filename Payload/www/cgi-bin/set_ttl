#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

TTL_FILE="/usrdata/simplefirewall/ttlvalue"
TTL_OVERRIDE_SCRIPT="/usrdata/simplefirewall/ttl-override"

url_decode() {
    local data="${1//+/ }"
    printf '%b' "${data//%/\\x}"
}

parse_params() {
    local qs="$1"
    ttlvalue=""

    IFS='&' read -ra pairs <<< "$qs"
    for pair in "${pairs[@]}"; do
        [ -z "$pair" ] && continue
        key="${pair%%=*}"
        val="${pair#*=}"
        val=$(url_decode "$val")
        case "$key" in
            ttlvalue) ttlvalue="$val" ;;
        esac
    done
}

if ! session_load; then
    send_json_response 401 '{"status":"error","message":"Authentication required"}'
    exit 0
fi

if ! session_require_role "admin"; then
    send_json_response 403 '{"status":"error","message":"Admin privileges required"}'
    exit 0
fi

case "${REQUEST_METHOD:-GET}" in
    GET)
        parse_params "${QUERY_STRING:-}"
        ;;
    POST)
        if [ -n "${CONTENT_LENGTH:-}" ]; then
            read -r -n "$CONTENT_LENGTH" POST_DATA
        else
            read -r POST_DATA
        fi
        parse_params "$POST_DATA"
        ;;
    *)
        send_json_response 405 '{"status":"error","message":"Unsupported method"}'
        exit 0
        ;;
esac

ttlvalue="${ttlvalue//[[:space:]]/}"
if [ -z "$ttlvalue" ]; then
    send_json_response 400 '{"status":"error","message":"Missing ttlvalue parameter"}'
    exit 0
fi

if ! [[ "$ttlvalue" =~ ^[0-9]{1,3}$ ]]; then
    send_json_response 400 '{"status":"error","message":"ttlvalue must be an integer between 0 and 255"}'
    exit 0
fi

ttlvalue_int=$((10#$ttlvalue))
if [ "$ttlvalue_int" -lt 0 ] || [ "$ttlvalue_int" -gt 255 ]; then
    send_json_response 400 '{"status":"error","message":"ttlvalue out of range (0-255)"}'
    exit 0
fi

if [ ! -x "$TTL_OVERRIDE_SCRIPT" ]; then
    send_json_response 500 '{"status":"error","message":"TTL override backend not found"}'
    exit 1
fi

mkdir -p "$(dirname "$TTL_FILE")"
printf '%s\n' "$ttlvalue_int" > "$TTL_FILE"

tmp_log="/tmp/set_ttl_$$.log"
if ! "$TTL_OVERRIDE_SCRIPT" restart >"$tmp_log" 2>&1; then
    err_msg=$(tr -d '\r' < "$tmp_log" | tail -n 3 | tr '\n' '; ')
    rm -f "$tmp_log"
    err_msg=$(json_escape "$err_msg")
    send_json_response 500 "{\"status\":\"error\",\"message\":\"Failed to apply TTL\",\"details\":\"$err_msg\"}"
    exit 1
fi
rm -f "$tmp_log"

if [ "$ttlvalue_int" -eq 0 ]; then
    ttlenabled="false"
else
    ttlenabled="true"
fi

json_payload=$(cat <<EOF
{
  "status":"ok",
  "isEnabled":${ttlenabled},
  "ttl":${ttlvalue_int}
}
EOF
)

send_json_response 200 "$json_payload"
