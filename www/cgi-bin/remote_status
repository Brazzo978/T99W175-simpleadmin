#!/usr/bin/env python3
"""Check the remote SSH connectivity."""
from __future__ import annotations

import os
import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parents[3]
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

from remote_admin_backend.http_utils import HTTPError, handle_error, send_json  # type: ignore  # noqa: E402
from remote_admin_backend.ssh_client import RemoteConnectionError, run_health_check  # type: ignore  # noqa: E402


def main() -> None:
    try:
        stdout, stderr, exit_code = run_health_check()
    except RemoteConnectionError as exc:
        raise HTTPError(str(exc), status=500) from exc

    if exit_code != 0:
        raise HTTPError(stderr.strip() or "Unable to verify the remote connection.", status=500)

    send_json({"success": True, "message": stdout.strip() or "Connection OK"})


if __name__ == "__main__":
    try:
        main()
    except HTTPError as error:
        handle_error(error)
    except Exception as exc:  # pragma: no cover
        handle_error(HTTPError(f"Unexpected error: {exc}", status=500))
