#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

# URL decode helper
urldecode() {
    local data="${1//+/ }"
    printf '%b' "${data//%/\\x}"
}

get_query_param() {
    local name="$1"
    local raw_query="${QUERY_STRING:-}"
    local pair key value

    if [ -z "$raw_query" ]; then
        return 1
    fi

    IFS='&' read -r -a pairs <<< "$raw_query"
    for pair in "${pairs[@]}"; do
        key="${pair%%=*}"
        value="${pair#*=}"
        if [ "$key" = "$name" ]; then
            printf '%s' "$value"
            return 0
        fi
    done

    return 1
}

CONFIG_PATH="${CONFIG_FILE:-$SCRIPT_DIR/../config/simpleadmin.conf}"
if [ ! -f "$CONFIG_PATH" ]; then
    send_json_response 404 '{"success":false,"message":"Configuration file not found"}'
    exit 0
fi

EXPECTED_KEY="${SIMPLEADMIN_WEBUI_KEY:-}"
if [ -z "$EXPECTED_KEY" ]; then
    send_json_response 500 '{"success":false,"message":"Web UI key is not configured"}'
    exit 0
fi

KEY_RAW="$(get_query_param "key" || true)"
if [ -z "$KEY_RAW" ]; then
    send_json_response 400 '{"success":false,"message":"Missing key parameter"}'
    exit 0
fi

KEY_VALUE="$(urldecode "$KEY_RAW")"
if [ "$KEY_VALUE" != "$EXPECTED_KEY" ]; then
    send_json_response 403 '{"success":false,"message":"Invalid key"}'
    exit 0
fi

CURRENT_STATE="${SIMPLEADMIN_WEBUI_DISABLED:-0}"
if [ "$CURRENT_STATE" = "true" ]; then
    CURRENT_STATE=1
fi

ENABLED_RAW="$(get_query_param "enabled" || true)"
if [ -n "$ENABLED_RAW" ]; then
    ENABLED_VALUE="$(urldecode "$ENABLED_RAW")"
    case "$ENABLED_VALUE" in
        0|1) TARGET_STATE="$ENABLED_VALUE" ;;
        *)
            send_json_response 400 '{"success":false,"message":"Invalid enabled value"}'
            exit 0
            ;;
    esac
else
    if [ "$CURRENT_STATE" = "1" ]; then
        TARGET_STATE=0
    else
        TARGET_STATE=1
    fi
fi

if grep -q '^SIMPLEADMIN_WEBUI_DISABLED=' "$CONFIG_PATH"; then
    sed -i "s/^SIMPLEADMIN_WEBUI_DISABLED=.*/SIMPLEADMIN_WEBUI_DISABLED=$TARGET_STATE/" "$CONFIG_PATH"
else
    printf '\nSIMPLEADMIN_WEBUI_DISABLED=%s\n' "$TARGET_STATE" >> "$CONFIG_PATH"
fi

if ! grep -q "^SIMPLEADMIN_WEBUI_DISABLED=$TARGET_STATE" "$CONFIG_PATH"; then
    send_json_response 500 '{"success":false,"message":"Failed to update configuration"}'
    exit 0
fi

payload=$(cat <<JSON
{
  "success": true,
  "data": {
    "disabled": ${TARGET_STATE:-0}
  }
}
JSON
)

send_json_response 200 "$payload"
