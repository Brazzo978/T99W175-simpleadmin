#!/usr/bin/env python3
"""Fetch the remote uptime via SSH."""
from __future__ import annotations

import os
import sys
from pathlib import Path

def _find_project_root() -> Path:
    current = Path(__file__).resolve()
    for candidate in current.parents:
        if (candidate / "remote_admin_backend").is_dir():
            return candidate
    return current.parents[0]


ROOT = _find_project_root()
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

from remote_admin_backend.http_utils import HTTPError, handle_error, send_text  # type: ignore  # noqa: E402
from remote_admin_backend.ssh_client import RemoteConnectionError, execute_remote  # type: ignore  # noqa: E402


def main() -> None:
    try:
        stdout, stderr, exit_code = execute_remote("uptime -p", timeout=10)
    except RemoteConnectionError as exc:
        raise HTTPError(str(exc), status=500) from exc

    if exit_code != 0:
        message = stderr.strip() or "Unable to retrieve uptime."
        raise HTTPError(message, status=500)

    send_text(stdout.strip() or "Unknown")


if __name__ == "__main__":
    try:
        main()
    except HTTPError as error:
        handle_error(error)
    except Exception as exc:  # pragma: no cover
        handle_error(HTTPError(f"Unexpected error: {exc}", status=500))
