#!/usr/bin/env python3
"""Execute AT commands typed by the user via SSH."""
from __future__ import annotations

import os
import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parents[3]
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

from remote_admin_backend.http_utils import (  # type: ignore  # noqa: E402
    HTTPError,
    decode_param,
    handle_error,
    parse_query,
    send_text,
)
from remote_admin_backend.ssh_client import (  # type: ignore  # noqa: E402
    RemoteCommandError,
    RemoteConnectionError,
    run_at_command,
)


def main() -> None:
    environ = os.environ.copy()

    params = parse_query(environ)
    atcmd = decode_param(params.get("atcmd", ""))

    if not atcmd:
        raise HTTPError("Missing atcmd parameter.")

    try:
        stdout, stderr, exit_code = run_at_command(atcmd)
    except RemoteConnectionError as exc:
        raise HTTPError(str(exc), status=500) from exc
    except RemoteCommandError as exc:  # pragma: no cover
        raise HTTPError(str(exc), status=500) from exc

    payload = [atcmd, ""]

    if stdout.strip():
        payload.append(stdout.strip())
    if stderr.strip():
        payload.append(stderr.strip())
    if not stdout.strip() and not stderr.strip():
        if exit_code != 0:
            payload.append(f"ERROR: remote command exited with code {exit_code}.")
        else:
            payload.append("ERROR: empty response from modem.")

    send_text("\n".join(payload))


if __name__ == "__main__":
    try:
        main()
    except HTTPError as error:
        handle_error(error)
    except Exception as exc:  # pragma: no cover - unexpected error guard
        handle_error(HTTPError(f"Unexpected error: {exc}", status=500))
