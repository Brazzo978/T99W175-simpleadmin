#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

ensure_credentials_file
ensure_session_store

if gui_is_locked; then
    # Always return 200 so the frontend can detect "locked" and redirect without
    # needing an extra endpoint (no extra roundtrip).
    send_json_response 200 "{\"authenticated\":false,\"gui_locked\":true,\"gui_lock_page\":\"$(json_escape "${SIMPLEADMIN_GUI_LOCK_PAGE:-/webguioff.html}")\"}"
    exit 0
fi

if session_load; then
    send_json_response 200 "{\"authenticated\":true,\"gui_locked\":false,\"gui_lock_page\":\"$(json_escape "${SIMPLEADMIN_GUI_LOCK_PAGE:-/webguioff.html}")\",\"username\":\"$(json_escape "$SESSION_USERNAME")\",\"role\":\"$(json_escape "$SESSION_ROLE")\"}"
else
    send_json_response 200 "{\"authenticated\":false,\"gui_locked\":false,\"gui_lock_page\":\"$(json_escape "${SIMPLEADMIN_GUI_LOCK_PAGE:-/webguioff.html}")\"}"
fi
